# Измеритель скорости шины modbus

>Использует бибилиотеку minimalmodbus
>Написано на Python (с классами)

>**Работает только RTU, рабочий скрипт `modbusreadmeter_mod.py`**

## Алгоритм Modbus RTU

Многократно в цикле опрашивает заданное количество адресов (устройств) и заданное количество регистров. Делает задаваемое количество циклов измерений и считает сколько измерений попало в текущую пару "минута:секунда".

 Накапливает данные, убирает первое и последнее измерение (неполные секунды начала и конца) и считает скорость. 
 
Чем больше циклов,тем больше статистики и больше точность. Но в целом, достаточно накопить 5-6 полных циклов измерений в текущую секунду. Пользователь сам определяет количество циклов и если их недостаточно, программка предупреждает.

Также программка считает скорость запроса, 
время функции 
```instrument.read_register(register, functioncode=3)```
и выдает среднее значение по всем итерациям



```python

modbusreadmeter.py [-h] [-D PORT] [-b BAUDRATE] [-d BYTESIZE] [-p {N,E,O,M,S}] [-s STOPBITS] [-c CIRCLES] [-a D_ADDRESSES] [-r REGISTERS] [-v]

Измеритель скорости Modbus RTU. Параметры с ключиком -h. По умолчанию ttyS1, 1152008E1

options:
  -h, --help            show this help message and exit
  -D PORT, --port PORT  Название порта
  -b BAUDRATE, --baudrate BAUDRATE
                        Скорость передачи данных
  -d BYTESIZE, --bytesize BYTESIZE
                        Размер байта
  -p {N,E,O,M,S}, --parity {N,E,O,M,S}
                        Бит четности
  -s STOPBITS, --stopbits STOPBITS
                        Количество стоп-бит
  -c CIRCLES, --circles CIRCLES
                        Количество циклов полного опроса устройства
  -a D_ADDRESSES, --d_addresses D_ADDRESSES
                        Адреса устройств для чтения (через запятую)
  -r REGISTERS, --registers REGISTERS
                        Регистры для чтения (через запятую)
  -v, --verbose         Включить подробный вывод
 
 ```

## Вывод программы

По умолчанию читается устройство с адресом "1" и один регистр "1" типа 16INT (16 бит). 

Final Dict: словарь накопленных результатов, из него убираем первый и последний элемент и имеем копленные ответы в период времени.

```bash
#python3 ./modbusreadmeter_mod.py -D /dev/ttyUSB1 

Адреса устройств для чтения: [1]
Регистры для чтения:         [1]
Циклов чтения:               300
Параметры порта:             Port: /dev/ttyusb1
                             Baudrate: 115200
                             Parity: e
                             Bytesize: 8
                             Stopbits: 1
                             Timeout: 1
Проверка порта...            Тест порта успешно
Начинаем опрос датчиков...
Итоговый словарь:{2993: 63, 2994: 62, 2995: 63, 2996: 62}
Средняя скорость запроса ВСЕХ регистров в ms: 16.0
Скорость одного датчика в ms:                 16.0
Скорость одного опроса ВСЕХ датчиков:         15.31
Всего ошибок:                                 0
```

> Изменить адреса, регистры можно через параметры. 
> Например, почитаем устройства 1,2 и регистры 0,1,2,3

```bash
#python3 ./modbusreadmeter_mod.py -D /dev/ttyUSB1 -a 1,2 -r 0,1,2,3

Адреса устройств для чтения: [1, 2]
Регистры для чтения:         [0, 1, 2, 3]
Циклов чтения:               300
Параметры порта:             Port: /dev/ttyusb1
                             Baudrate: 115200
                             Parity: e
                             Bytesize: 8
                             Stopbits: 1
                             Timeout: 1
Проверка порта...            Тест порта успешно
Начинаем опрос датчиков...
Итоговый словарь:{1459: 16, 1460: 15, 1461: 16, 1462: 16, 1463: 15, 1464: 16, 1465: 15, 1466: 16, 1467: 16, 1468: 15, 1469: 16, 1470: 16, 1471: 15, 1472: 16, 1473: 15, 1474: 16, 1475: 16, 1476: 15, 1477: 16, 1478: 16, 1479: 15, 1480: 16, 1481: 15, 1482: 16, 1483: 16, 1484: 15, 1485: 16, 1486: 16, 1487: 15, 1488: 16, 1489: 15, 1490: 16, 1491: 16, 1492: 15, 1493: 16, 1494: 16, 1495: 15}
Средняя скорость запроса ВСЕХ регистров в ms: 64.01
Скорость одного датчика в ms:                 16.0
Скорость одного опроса ВСЕХ датчиков:         63.39
Всего ошибок:                                 0
```
